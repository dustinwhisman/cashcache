---
title: Add Recurring Expense
layout: layouts/simple-layout.njk
description: Add a recurring expense so you can save time in the future and won't forget to track your insurance or a subscription.
---

<style>
  .dates-grid {
    display: grid;
    grid-gap: 0.75em;
    grid-template-columns: repeat(7, max-content);
    font-size: calc(var(--h6));
  }
</style>

<h1>
  Add Recurring Expense
</h1>

<div>
  <a href="/recurring-expenses" data-back-link>
    Go Back
  </a>
</div>

<form class="stack">
  {% include "inputs/category-inputs.njk" %}
  <div>
    <label for="expense-description">
      Description
    </label>
    <input id="expense-description" type="text" name="expense-description" required>
  </div>
  <div>
    <label for="amount">
      Amount
    </label>
    <input id="amount" type="text" name="amount" inputmode="numeric" pattern="^(\s{1,})?\$?\d{1,3}(,?\d{3})*(\.\d+)?(\s{1,})?$" style="width: 12ch" autofill="false" autocomplete="off" required>
  </div>
  <fieldset>
    <legend>
      Frequency
    </legend>
    <div class="stack" style="--stack-space: 0.5em">
      <label class="custom-checkbox">
        <input type="radio" name="frequency" value="1-month" checked>
        {% include "svgs/radio-svg.njk" %}
        <span>
          Every Month
        </span>
      </label>
      <label class="custom-checkbox">
        <input type="radio" name="frequency" value="3-month">
        {% include "svgs/radio-svg.njk" %}
        <span>
          Every 3 Months
        </span>
      </label>
      <label class="custom-checkbox">
        <input type="radio" name="frequency" value="6-month">
        {% include "svgs/radio-svg.njk" %}
        <span>
          Every 6 Months
        </span>
      </label>
      <label class="custom-checkbox">
        <input type="radio" name="frequency" value="1-year">
        {% include "svgs/radio-svg.njk" %}
        <span>
          Every Year
        </span>
      </label>
      <label class="custom-checkbox">
        <input type="radio" name="frequency" value="1-week">
        {% include "svgs/radio-svg.njk" %}
        <span>
          Every Week
        </span>
      </label>
      <label class="custom-checkbox">
        <input type="radio" name="frequency" value="2-week">
        {% include "svgs/radio-svg.njk" %}
        <span>
          Every 2 Weeks
        </span>
      </label>
      <label class="custom-checkbox">
        <input type="radio" name="frequency" value="twice-per-month">
        {% include "svgs/radio-svg.njk" %}
        <span>
          Twice per Month
        </span>
      </label>
    </div>
  </fieldset>
  {% include "inputs/complex-dates.njk" %}
  <label class="custom-checkbox">
    <input type="checkbox" name="active" checked>
    {% include "svgs/checkbox-svg.njk" %}
    <span>
      This recurring expense is currently active
    </span>
  </label>
  <input type="hidden" name="key" value="">
  <div>
    <span class="visually-hidden" role="status" data-submit-status></span>
    <button type="submit" data-label-saving="Saving..." data-label-saved="Saved!" data-label-failed="Failed to Save. Try Again?">
      Save Recurring Expense
    </button>
  </div>
</form>

{% include "scripts/firebase.njk" %}
{% include "scripts/sanitize.njk" %}
<script type="module">
  import { getAllCategories, getAllCategoriesFromCloud, addToDb } from '/scripts/db.mjs';
  import { updateBackLink, addCategoryEventListener, initializeComplexDates } from '/scripts/utilities/index.mjs';

  updateBackLink();
  addCategoryEventListener();
  initializeComplexDates();

  if (!appUser?.uid || !isPayingUser) {
    window.location.href = '/recurring-expenses';
  }

  const storeName = 'expenses';
  let networkCategoriesLoaded = false;
  let cachedCategoriesLoaded = false;
  const renderCategories = (categories) => {
    const categoriesDiv = document.querySelector('[data-category]');
    let categoryTemplate = `
      <label class="custom-checkbox">
        <input type="radio" name="category" value="new-category" required>
        {% include "svgs/radio-svg.njk" %}
        <span>
          New Category
        </span>
      </label>
    `;
    categories?.sort().forEach((category) => {
      categoryTemplate += `
        <label class="custom-checkbox">
          <input type="radio" name="category" value="${category}" required>
          {% include "svgs/radio-svg.njk" %}
          <span>
            ${category}
          </span>
        </label>
      `;

    });
    categoriesDiv.innerHTML = categoryTemplate;
  };

  document.addEventListener('submit', async (event) => {
    event.preventDefault();

    const { elements } = event.target;
    const expense = {
      uid: appUser?.uid,
      key: elements['key'].value || null,
      category: elements['category'].value === 'new-category' ? elements['new-category'].value : elements['category'].value,
      description: elements['expense-description'].value,
      amount: sanitize(elements['amount'].value),
      year: Number(elements['year'].value),
      month: Number(elements['month'].value) - 1,
      day: Number(elements['day'].value),
      frequency: elements['frequency'].value,
      daysOfMonth: Array.from(elements['days-of-month']).filter(checkbox => checkbox.checked).map(checkbox => Number(checkbox.value)),
      active: elements['active'].checked,
    };

    const statusElement = document.querySelector('[data-submit-status]');
    const button = event.target.querySelector('button[type=submit]');
    const savingMessage = button.dataset.labelSaving;
    const savedMessage = button.dataset.labelSaved;
    const failedMessage = button.dataset.labelFailed;

    try {
      button.innerHTML = savingMessage;
      statusElement.innerHTML = savingMessage;

      await addToDb('recurring-expenses', expense);

      button.innerHTML = savedMessage;
      statusElement.innerHTML = savedMessage;

      window.location.href = `/recurring-expenses`;
    } catch (error) {
      button.innerHTML = failedMessage;
      statusElement.innerHTML = failedMessage;
      console.error(error);
    }
  });

  (async () => {
    const categories = await getAllCategories(storeName);
    cachedCategoriesLoaded = true;

    if (!networkCategoriesLoaded) {
      renderCategories(categories);
    }
  })();

  document.addEventListener('token-confirmed', async () => {
    if (appUser?.uid && isPayingUser) {
      const categories = await getAllCategoriesFromCloud(storeName, appUser?.uid);
      networkCategoriesLoaded = true;

      if (!cachedCategoriesLoaded) {
        renderCategories(categories);
      } else {
        const form = document.querySelector('form');
        const category = form.elements['category'].value;

        let categoryInput = document.querySelector(`[name=category][value="${category}"]`);
        const isFocused = categoryInput === document.activeElement;
        renderCategories(categories);
        categoryInput = document.querySelector(`[name=category][value="${category}"]`);
        if (categoryInput) {
          categoryInput.checked = true;
          if (isFocused) {
            categoryInput.focus();
          }
        }
      }
    }
  });
</script>
